---
title: "var model & results"
author: "Zeyu Hu"
date: "2024-10-09"
output: html_document
---

## read vacc data
```{r echo=FALSE}
library(dplyr)
library(tidyr)
library(readxl)
data <- read_excel("../data/owid-covid-data (4).xlsx")
south_korea_data <- data %>%
  filter(location == "South Korea")
korea_vacc <- south_korea_data %>% dplyr::select(1:4, people_fully_vaccinated)
vacctargetdate <- korea_vacc %>%
  slice(176:672) # 2020.6.28~2021.11.6

vacctotal <- vacctargetdate %>%
  dplyr::select(date, people_fully_vaccinated) %>%  # 选择所需的列
  slice(seq(7, n(), by = 7))  # 选择7的倍数行

vacctotal$people_fully_vaccinated_rate <- vacctotal$people_fully_vaccinated/51854000
vacctotal <- vacctotal %>%
  dplyr::mutate(people_fully_vaccinated_rate = replace_na(people_fully_vaccinated_rate, 0))
```

## build model for total 
```{r echo=FALSE}
library(vars)
varnew <- read.csv("../data/total_Seoul_PMI.csv")
varnew$vac_rate <- vacctotal$people_fully_vaccinated_rate
wholedata <- varnew
start_time <- c(2020, 27)

# 将内生变量（incidence, mobility, policy）转换为时间序列数据
varnew_ts <- ts(varnew[, c("incidences", "mobility", "policy")], start = start_time, frequency = 52)

# 将外生变量 vacc_rate 也转换为时间序列数据
vacc_rate_ts <- ts(wholedata$vac_rate, start = start_time, frequency = 52)
vacc_rate_ts_df <- data.frame(vacc_rate = vacc_rate_ts)

# 滞后选择（基于 AIC、HQ 和 SC）
(lag_selection <- VARselect(varnew_ts, lag.max = 10, type = "both"))


# 构建 VARX 模型，p = 2 表示选择了 2 阶滞后
varx_model <- VAR(varnew_ts, p = 2, type = "both", exogen = vacc_rate_ts_df)
```

## data geom plot
```{r echo=FALSE}
library(ggplot2)
library(gridExtra)
library(grid)
library(cowplot)
wholedata$rank <- c(1:71)

# 绘制图像，使用 rank 作为 x 轴，并且将 x_label 添加为刻度（去除 NA）
policydataplot <- ggplot(data = wholedata, aes(x = rank, y = policy)) +
  geom_line(color = "blue", size = 1.2) +
  scale_x_continuous(breaks = wholedata$rank, 
                     labels = ifelse(is.na(wholedata$x_label), "", wholedata$x_label),
                     expand = c(0, 1)) +  # 移除左右空白
  labs(title = "",
       x = "",
       y = "Policy level") +
  theme_classic() +  # 使用经典主题
  theme(panel.grid.major.y = element_line(color = "grey80"),  # 设置 y 轴主要网格线
        panel.grid.minor.y = element_line(color = "grey90"),  # 设置 y 轴次要网格线
        panel.grid.major.x = element_line(color = "grey80"),  # 设置 x 轴主要网格线
        axis.text.x = element_text(size = 25, face = "bold"),  # x 轴刻度标签字体放大和加粗
        axis.text.y = element_text(size = 25, face = "bold"),  # y 轴刻度标签字体放大和加粗
        axis.title.y = element_text(size = 25, face = "bold"),  # y 轴标题字体放大和加粗
        axis.ticks.x = element_line(color = "black"),  # 确保 x 轴刻度显示
        panel.border = element_rect(color = "black", fill = NA, size = 1),  # 添加黑色边框
        plot.title = element_blank())  # 移除图表标题
incidencedataplot <- ggplot(data = wholedata, aes(x = rank, y = incidences)) +
  geom_line(color = "red", size = 1.2) +
  scale_x_continuous(breaks = wholedata$rank, 
                     labels = ifelse(is.na(wholedata$x_label), "", wholedata$x_label),
                     expand = c(0, 1)) +  # 移除左右空白
  labs(title = "", 
       x = "", 
       y = "Incidences \n(in hundreds)") +
  theme_classic() +
  theme(panel.grid.major.y = element_line(color = "grey80"),  
        panel.grid.minor.y = element_line(color = "grey90"),  
        panel.grid.major.x = element_line(color = "grey80"),  
        axis.text.x = element_text(size = 25, face = "bold"),  
        axis.text.y = element_text(size = 25, face = "bold"),  
        axis.title.y = element_text(size = 25, face = "bold"),  
        axis.ticks.x = element_line(color = "black"),  
        panel.border = element_rect(color = "black", fill = NA, size = 1),  
        plot.title = element_blank())

mobilitydataplot <- ggplot(data = wholedata, aes(x = rank, y = mobility)) +
  geom_line(color = "purple", size = 1.2) +
  scale_x_continuous(breaks = wholedata$rank, 
                     labels = ifelse(is.na(wholedata$x_label), "", wholedata$x_label),
                     expand = c(0, 1)) +  # 移除左右空白
  labs(title = "", 
       x = "", 
       y = "Mobility \n(in millions)") +
  theme_classic() +
  theme(panel.grid.major.y = element_line(color = "grey80"),  
        panel.grid.minor.y = element_line(color = "grey90"),  
        panel.grid.major.x = element_line(color = "grey80"),  
        axis.text.x = element_text(size = 25, face = "bold"),  
        axis.text.y = element_text(size = 25, face = "bold"),  
        axis.title.y = element_text(size = 25, face = "bold"),  
        axis.ticks.x = element_line(color = "black"),  
        panel.border = element_rect(color = "black", fill = NA, size = 1),  
        plot.title = element_blank())

vacratedataplot <- ggplot(data = wholedata, aes(x = rank, y = vac_rate)) +
  geom_line(color = "green", size = 1.2) +
  scale_x_continuous(breaks = wholedata$rank, 
                     labels = ifelse(is.na(wholedata$x_label), "", wholedata$x_label),
                     expand = c(0, 1)) +  # 移除左右空白
  labs(title = "", 
       x = "", 
       y = "Vaccination rate") +
  theme_classic() +
  theme(panel.grid.major.y = element_line(color = "grey80"),  
        panel.grid.minor.y = element_line(color = "grey90"),  
        panel.grid.major.x = element_line(color = "grey80"),  
        axis.text.x = element_text(size = 25, face = "bold"),  
        axis.text.y = element_text(size = 25, face = "bold"),  
        axis.title.y = element_text(size = 25, face = "bold"),  
        axis.ticks.x = element_line(color = "black"),  
        panel.border = element_rect(color = "black", fill = NA, size = 1),  
        plot.title = element_blank())

g1 <- ggplotGrob(policydataplot)
g2 <- ggplotGrob(incidencedataplot)
g3 <- ggplotGrob(mobilitydataplot)
g4 <- ggplotGrob(vacratedataplot) 

maxWidth <- unit.pmax(g1$widths[2:3], g2$widths[2:3], g3$widths[2:3], g4$widths[2:3])

# 设置每个图的左边距为相同的宽度
g1$widths[2:3] <- maxWidth
g2$widths[2:3] <- maxWidth
g3$widths[2:3] <- maxWidth
g4$widths[2:3] <- maxWidth

# 使用 cowplot 的 plot_grid 来确保对齐
combined_dataplot <- plot_grid(g1, g2, g3, g4, ncol = 1, align = "v")
ggsave("../result/figure/data.jpg", combined_dataplot, width = 23, height = 15, units = "in", dpi = 300)
```
## actual vs fitted
```{r echo=FALSE}
# Get the total length of the data
n <- nrow(varnew_ts)

# Get fitted values and residuals
fitted_values <- fitted(varx_model)
residuals_values <- residuals(varx_model)

# Adjust the length of fitted values and residuals to match the original data
fitted_incidences <- c(rep(NA, n - nrow(fitted_values)), fitted_values[, "incidences"])
residuals_incidences <- c(rep(NA, n - nrow(residuals_values)), residuals_values[, "incidences"])

fitted_mobility <- c(rep(NA, n - nrow(fitted_values)), fitted_values[, "mobility"])
residuals_mobility <- c(rep(NA, n - nrow(residuals_values)), residuals_values[, "mobility"])

fitted_policy <- c(rep(NA, n - nrow(fitted_values)), fitted_values[, "policy"])
residuals_policy <- c(rep(NA, n - nrow(residuals_values)), residuals_values[, "policy"])

# Create data frames for each variable
data_incidences <- data.frame(
  time = time(varnew_ts),
  actual = varnew_ts[, "incidences"],
  fitted = fitted_incidences,
  residuals = residuals_incidences
)

data_mobility <- data.frame(
  time = time(varnew_ts),
  actual = varnew_ts[, "mobility"],
  fitted = fitted_mobility,
  residuals = residuals_mobility
)

data_policy <- data.frame(
  time = time(varnew_ts),
  actual = varnew_ts[, "policy"],
  fitted = fitted_policy,
  residuals = residuals_policy
)

# Convert data to long format for ggplot
data_long_incidences <- data_incidences %>%
  gather(key = "Type", value = "Value", actual, fitted)

data_long_mobility <- data_mobility %>%
  gather(key = "Type", value = "Value", actual, fitted)

data_long_policy <- data_policy %>%
  gather(key = "Type", value = "Value", actual, fitted)

# Plot fitted and actual values for each variable
data_long_incidences$x_label <- rep(varnew$x_label, length.out = 142)
fit_plot_incidences <- ggplot(data_long_incidences, aes(x = time, y = Value, color = Type)) +
  geom_line(size = 1) +
  labs(y = "Incidences (in hunderd)",
       x = NULL) +
  scale_color_manual(values = c("actual" = "black", "fitted" = "blue")) +
  scale_x_continuous(breaks = data_long_incidences$time[!is.na(data_long_incidences$x_label)],   
                     labels = data_long_incidences$x_label[!is.na(data_long_incidences$x_label)]) +
  theme(plot.background = element_rect(fill = "white", colour = NA),
        panel.background = element_rect(fill = "white", colour = NA),  # 子图背景颜色
        panel.grid.major = element_line(color = "grey90"),
        panel.grid.minor = element_line(color = NA),  # 去除次网格线
        text = element_text(size = 20, face = "bold"), # Default text size and style for the entire plot
        plot.title = element_text(size = 25, face = "bold", hjust = 0.5), # Title
        axis.title = element_text(size = 20, face = "bold"), # Axis titles
        axis.text = element_text(size = 16, face = "bold"), # Axis text
        legend.title = element_text(size = 18, face = "bold"), # Legend title
        legend.text = element_text(size = 16, face = "bold"), # Legend text
        legend.position = "bottom", # 图例位置设置为底部
        legend.direction = "horizontal", # 图例横向排列
        legend.box = "horizontal",
        strip.background = element_rect(fill = "white", color = "white"), # facet_wrap 背景为白色
        strip.text = element_text(face = "bold", size = 16),
        panel.border = element_rect(color = "black", fill = NA, size = 1.5)) + # facet_wrap 标题为加粗
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5))
# 假设 fit_plot_incidences 是已生成的图形对象
# 保存为 JPG 文件
ggsave("../result/figure/fit plot incidences.jpg", 
       plot = fit_plot_incidences, 
       dpi = 300, 
       width = 16, 
       height = 10)


data_long_mobility$x_label <- rep(varnew$x_label, length.out = 142)
fit_plot_mobility <- ggplot(data_long_mobility, aes(x = time, y = Value, color = Type)) +
  geom_line(size = 1) +
  labs(y = "Mobility (in million)",
       x = NULL) +
  scale_color_manual(values = c("actual" = "black", "fitted" = "blue")) +
  scale_x_continuous(breaks = data_long_mobility$time[!is.na(data_long_mobility$x_label)],   
                     labels = data_long_mobility$x_label[!is.na(data_long_mobility$x_label)]) +
  theme(plot.background = element_rect(fill = "white", colour = NA),
        panel.background = element_rect(fill = "white", colour = NA),  # 子图背景颜色
        panel.grid.major = element_line(color = "grey90"),
        panel.grid.minor = element_line(color = NA),  # 去除次网格线
        text = element_text(size = 20, face = "bold"), # Default text size and style for the entire plot
        plot.title = element_text(size = 25, face = "bold", hjust = 0.5), # Title
        axis.title = element_text(size = 20, face = "bold"), # Axis titles
        axis.text = element_text(size = 16, face = "bold"), # Axis text
        legend.title = element_text(size = 18, face = "bold"), # Legend title
        legend.text = element_text(size = 16, face = "bold"), # Legend text
        legend.position = "bottom", # 图例位置设置为底部
        legend.direction = "horizontal", # 图例横向排列
        legend.box = "horizontal",
        strip.background = element_rect(fill = "white", color = "white"), # facet_wrap 背景为白色
        strip.text = element_text(face = "bold", size = 16),
        panel.border = element_rect(color = "black", fill = NA, size = 1.5)) + # facet_wrap 标题为加粗
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5))
ggsave("../result/figure/fit plot mobility.jpg", 
       plot = fit_plot_mobility, 
       dpi = 300, 
       width = 16, 
       height = 10)

data_long_policy$x_label <- rep(varnew$x_label, length.out = 142)
fit_plot_policy <- ggplot(data_long_policy, aes(x = time, y = Value, color = Type)) +
  geom_line(size = 1) +
  labs(y = "Policy",
       x = NULL) +
  scale_color_manual(values = c("actual" = "black", "fitted" = "blue")) +
  scale_x_continuous(breaks = data_long_policy$time[!is.na(data_long_policy$x_label)],   
                     labels = data_long_policy$x_label[!is.na(data_long_policy$x_label)]) + 
  theme(plot.background = element_rect(fill = "white", colour = NA),
        panel.background = element_rect(fill = "white", colour = NA),  # 子图背景颜色
        panel.grid.major = element_line(color = "grey90"),
        panel.grid.minor = element_line(color = NA),  # 去除次网格线
        text = element_text(size = 20, face = "bold"), # Default text size and style for the entire plot
        plot.title = element_text(size = 25, face = "bold", hjust = 0.5), # Title
        axis.title = element_text(size = 20, face = "bold"), # Axis titles
        axis.text = element_text(size = 16, face = "bold"), # Axis text
        legend.title = element_text(size = 18, face = "bold"), # Legend title
        legend.text = element_text(size = 16, face = "bold"), # Legend text
        legend.position = "bottom", # 图例位置设置为底部
        legend.direction = "horizontal", # 图例横向排列
        legend.box = "horizontal",
        strip.background = element_rect(fill = "white", color = "white"), # facet_wrap 背景为白色
        strip.text = element_text(face = "bold", size = 16),
        panel.border = element_rect(color = "black", fill = NA, size = 1.5)) + # facet_wrap 标题为加粗
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5))
ggsave("../result/figure/fit plot policy.jpg", 
       plot = fit_plot_policy, 
       dpi = 300, 
       width = 16, 
       height = 10)
```

## circle root plot
```{r echo=FALSE}
#jpeg("/Users/huzeyu/Desktop/UConnHealth/Policy_Incidence_Mobility/result/figure/roots_companion_matrix.jpg", 
#     width = 6, height = 6, units = "in", res = 300)
var_roots <- roots(varx_model)
plot(Re(var_roots), Im(var_roots), type = "p", 
     xlim = c(-1, 1), ylim = c(-1, 1),
     xlab = "Real", ylab = "Imaginary", 
     main = "Roots of the Companion Matrix",
     asp = 1)
symbols(0, 0, circles = 1, inches = FALSE, add = TRUE, fg = "blue")
abline(h = 0, v = 0, col = "gray")
#dev.off()

```

## IRF plots
```{r pressure, echo=FALSE}
library(vars)

# 定义所有的 irf 对象和文件名
irf_list <- list(
  ii = irf(varx_model, impulse = "incidences", response = "incidences", n.ahead = 10, boot = TRUE),
  im = irf(varx_model, impulse = "incidences", response = "mobility", n.ahead = 10, boot = TRUE),
  ip = irf(varx_model, impulse = "incidences", response = "policy", n.ahead = 10, boot = TRUE),
  mi = irf(varx_model, impulse = "mobility", response = "incidences", n.ahead = 10, boot = TRUE),
  mm = irf(varx_model, impulse = "mobility", response = "mobility", n.ahead = 10, boot = TRUE),
  mp = irf(varx_model, impulse = "mobility", response = "policy", n.ahead = 10, boot = TRUE),
  pi = irf(varx_model, impulse = "policy", response = "incidences", n.ahead = 10, boot = TRUE),
  pm = irf(varx_model, impulse = "policy", response = "mobility", n.ahead = 10, boot = TRUE),
  pp = irf(varx_model, impulse = "policy", response = "policy", n.ahead = 10, boot = TRUE)
)

# 定义相应的文件名
file_names <- c(
  "ii.jpg", "im.jpg", "ip.jpg", 
  "mi.jpg", "mm.jpg", "mp.jpg", 
  "pi.jpg", "pm.jpg", "pp.jpg"
)

# 定义保存路径
base_path <- "../result/figure/"

#  使用循环来保存所有的图像
for (i in 1:length(irf_list)) {
  
  # 创建完整的文件路径
  file_path <- paste0(base_path, file_names[i])
  
  # 提取 IRF 数据
  irf_values <- irf_list[[i]]$irf[[1]]
  upper_ci <- irf_list[[i]]$Upper[[1]]
  lower_ci <- irf_list[[i]]$Lower[[1]]
  time_horizon <- 1:nrow(irf_values)
  
  # 打开 jpeg 图像设备，分辨率设置为 600 DPI
  jpeg(file_path, width = 6.3, height = 4, units = "in", res = 600)
  
  # 设置边距，减少空白
  par(mar = c(3, 3, 2, 1))  # 调整下、左、上、右的边距

  # 绘制 IRF 图像，手动绘制以去除多余说明
  plot(time_horizon, irf_values, type = "l", col = "black", lwd = 2,
       xlab = "", ylab = "", main = "", ylim = range(c(lower_ci, upper_ci)))
  lines(time_horizon, upper_ci, col = "red", lty = 2)
  lines(time_horizon, lower_ci, col = "red", lty = 2)
  abline(h = 0, col = "red")
  
  # 关闭图形设备，保存文件
  dev.off()
}
```

## model for each district
```{r echo=FALSE}
dist_order <- c("total", "Jung", "Jongno", "Gangnam", "Yeongdeungpo", "Seocho", "Geumcheon", 
                "Yongsan", "Mapo", "Seongdong", "Dongdaemun", "Seodaemun", "Guro", 
                "Songpa", "Gangseo", "Seongbuk", "Gwangjin", "Dongjak", "Gangdong", 
                "Nowon", "Gangbuk", "Yangcheon", "Jungnang", "Dobong", "Gwanak", 
                "Eunpyeong")
dist_incidence <- read.csv("../data/dist_incidence.csv")
dist_incidence[, 2:27] <- dist_incidence[, 2:27] / 100
dist_mobility <- read.csv("../data/dist_mobility.csv")
dist_mobility[, 2:27] <- dist_mobility[, 2:27] / 1000000

PMI <- read.csv("../data/total_Seoul_PMI.csv")
# Get all region names
regions <- colnames(dist_incidence)[2:ncol(dist_incidence)]
# Merge data tables with renaming columns
merged_data <- merge(
  merge(
    setNames(dist_incidence, c(colnames(dist_incidence)[1], paste0(regions, "_incidence"))),
    setNames(dist_mobility, c(colnames(dist_mobility)[1], paste0(regions, "_mobility"))),
    by = "YEARMONTHWEEK"
  ), 
  PMI, 
  by = "YEARMONTHWEEK"
)

# Initialize a list to store VAR models
var_models <- list()

# Start time
start_time <- c(2020, 27)

# Loop to build VAR model for each region
for (region in regions) {
  # Create new data frame
  varnew <- data.frame(
    incidences = merged_data[[paste0(region, "_incidence")]],
    mobility = merged_data[[paste0(region, "_mobility")]],
    policy = merged_data$policy
  )
  
  # Convert data to time series
  varnew_ts <- ts(varnew, start = start_time, frequency = 52)
  
  # Build VAR model
  var_modelnew <- VAR(varnew_ts, p = 2, type = "both", exogen = vacc_rate_ts_df)
  
  # Store the model in the list
  var_models[[region]] <- var_modelnew
}

# 初始化一个空的数据框来存储结果
results <- data.frame(
  DIST = character(),
  Incidence.l1 = character(), Incidence.l2 = character(),
  Mobility.l1 = character(), Mobility.l2 = character(),
  Policy.l1 = character(), Policy.l2 = character(), trend = character(),
  Vacc = character(),  # 直接加入Vacc列，无滞后项
  Incidence.l1_mobility = character(), Incidence.l2_mobility = character(),
  Mobility.l1_mobility = character(), Mobility.l2_mobility = character(),
  Policy.l1_mobility = character(), Policy.l2_mobility = character(), trend_mobility = character(),
  Vacc_mobility = character(),  # 直接加入Vacc列，无滞后项（Mobility）
  Incidence.l1_policy = character(), Incidence.l2_policy = character(),
  Mobility.l1_policy = character(), Mobility.l2_policy = character(),
  Policy.l1_policy = character(), Policy.l2_policy = character(), trend_policy = character(),
  Vacc_policy = character(),  # 直接加入Vacc列，无滞后项（Policy）
  stringsAsFactors = FALSE
)

# 定义函数格式化系数和标准误差
format_coeff <- function(coef, se, pval) {
  formatted <- sprintf("%.3f (%.3f)", coef, se)
  if (pval < 0.05) {
    formatted <- paste0(formatted, "**")
  } else if (pval < 0.1) {
    formatted <- paste0(formatted, "*")
  }
  return(formatted)
}

# 遍历所有地区，提取每个VAR模型的结果
for (region in names(var_models)) {
  model <- var_models[[region]]
  summary_model <- summary(model)
  
  # 初始化一行数据
  row <- c(DIST = region)
  
  # 定义要提取的变量及其滞后项（不包含外生变量）
  variables <- c("incidences.l1", "incidences.l2",
                 "mobility.l1", "mobility.l2",
                 "policy.l1", "policy.l2", "trend")
  
  # 为每个模型提取系数和标准误差
  for (response in c("incidences", "mobility", "policy")) {
    coefficients <- coef(summary_model$varresult[[response]])
    
    for (var in variables) {
      coef <- coefficients[var, "Estimate"]
      se <- coefficients[var, "Std. Error"]
      pval <- coefficients[var, "Pr(>|t|)"]
      row <- c(row, format_coeff(coef, se, pval))
    }
    
    # 提取Vacc外生变量的系数及其标准误差和p值
    vacc_coef <- coefficients["vacc_rate", "Estimate"]
    vacc_se <- coefficients["vacc_rate", "Std. Error"]
    vacc_pval <- coefficients["vacc_rate", "Pr(>|t|)"]
    row <- c(row, format_coeff(vacc_coef, vacc_se, vacc_pval))
  }
  
  # 添加这一行到结果数据框
  results <- rbind(results, row)
}

# 定义新的列名（包含 Vacc 变量列）
colnames(results) <- c("DIST",
                       "Incidence.l1", "Incidence.l2",
                       "Mobility.l1", "Mobility.l2",
                       "Policy.l1", "Policy.l2", "trend",
                       "Vacc",  # 外生变量Vacc
                       "Incidence.l1_mobility", "Incidence.l2_mobility",
                       "Mobility.l1_mobility", "Mobility.l2_mobility",
                       "Policy.l1_mobility", "Policy.l2_mobility", "trend_mobility",
                       "Vacc_mobility",  # 外生变量Vacc（Mobility）
                       "Incidence.l1_policy", "Incidence.l2_policy",
                       "Mobility.l1_policy", "Mobility.l2_policy",
                       "Policy.l1_policy", "Policy.l2_policy", "trend_policy",
                       "Vacc_policy")  # 外生变量Vacc（Policy）

# 格式化 DIST 列，去除 "-gu" 后缀
results$DIST <- sub("-gu", "", results$DIST)

# 根据指定顺序对DIST进行排序
results <- results[match(dist_order, results$DIST), ]
library(writexl)
write_xlsx(results, "../result/results.xlsx")

```

## heat map for significance in each district
```{r echo=FALSE}
# 加载必要的包
library(ggplot2)
library(reshape2)
library(gridExtra)
library(patchwork)
# 准备数据：每个模型对应的结果
results_incidence <- results[, c("DIST", paste0("Incidence.l", 1:2), "Mobility.l1", 
                                 "Mobility.l2", "Policy.l1", "Policy.l2", "Vacc")]
colnames(results_incidence) <- c("DIST", "Incidence_Lag1", "Incidence_Lag2", 
                                 "Mobility_Lag1", "Mobility_Lag2", 
                                 "Policy_Lag1", "Policy_Lag2", "Vaccination")

results_mobility <- results[, c("DIST", paste0("Incidence.l", 1:2, "_mobility"), 
                                "Mobility.l1_mobility", "Mobility.l2_mobility", 
                                "Policy.l1_mobility", "Policy.l2_mobility", "Vacc_mobility")]
colnames(results_mobility) <- c("DIST", "Incidence_Lag1", "Incidence_Lag2", 
                                 "Mobility_Lag1", "Mobility_Lag2", 
                                 "Policy_Lag1", "Policy_Lag2", "Vaccination")

results_policy <- results[, c("DIST", paste0("Incidence.l", 1:2, "_policy"), 
                              "Mobility.l1_policy", "Mobility.l2_policy", 
                              "Policy.l1_policy", "Policy.l2_policy", "Vacc_policy")]
colnames(results_policy) <- c("DIST", "Incidence_Lag1", "Incidence_Lag2", 
                                "Mobility_Lag1", "Mobility_Lag2", 
                                "Policy_Lag1", "Policy_Lag2", "Vaccination")
# 将结果表格转换为长格式
results_incidence_long <- melt(results_incidence, id.vars = "DIST", 
                               variable.name = "Variable", value.name = "Coefficient")
results_mobility_long <- melt(results_mobility, id.vars = "DIST", 
                              variable.name = "Variable", value.name = "Coefficient")
results_policy_long <- melt(results_policy, id.vars = "DIST", 
                            variable.name = "Variable", value.name = "Coefficient")

heatorder <- c("All districts", "Jung", "Jongno", "Gangnam", "Yeongdeungpo", "Seocho", 
               "Geumcheon","Yongsan", "Mapo", "Seongdong", "Dongdaemun", "Seodaemun", 
               "Guro", "Songpa", "Gangseo", "Seongbuk", "Gwangjin", "Dongjak", "Gangdong", 
                "Nowon", "Gangbuk", "Yangcheon", "Jungnang", "Dobong", "Gwanak", 
                "Eunpyeong")

# 函数：根据系数和显著性创建颜色
get_color <- function(coef, sig) {
  if (coef > 0 && sig == "**") {
    return("#B22222")
  } else if (coef > 0 && sig == "*") {
    return("#F08080")
  } else if (coef < 0 && sig == "**") {
    return("blue")
  } else if (coef < 0 && sig == "*") {
    return("#ADD8E6")
  } else {
    return("gray")  # 非显著性结果用白色表示
  }
}

# 定义一个处理数据框的函数
process_data <- function(data) {
  # 替换 'total' 为 'All districts'
  data$DIST <- ifelse(data$DIST == "total", "All districts", data$DIST)
  
  # 提取系数值并去除显著性标记（* 或 **）和括号内的标准误
  data$Coefficient_value <- as.numeric(gsub("\\*|\\(|\\)|\\s|\\*\\*", "", 
                                            gsub("\\(.*\\)", "", data$Coefficient)))
  
  # 提取显著性标记（处理 ** 和 *）
  data$Significance <- ifelse(grepl("\\*\\*", data$Coefficient), "**", 
                              ifelse(grepl("\\*", data$Coefficient), "*", ""))
  
  # 添加颜色列（基于函数 get_color）
  data$Color <- mapply(get_color, data$Coefficient_value, data$Significance)
  
  return(data)
}

# 使用列表保存所有数据框
data_list <- list(results_incidence_long, results_mobility_long, results_policy_long)

# 使用 lapply 循环对每个数据框应用相同的处理
processed_data_list <- lapply(data_list, process_data)

# 将处理后的数据框赋值回原始变量
results_incidence_long <- processed_data_list[[1]]
results_incidence_long <- results_incidence_long %>%
  mutate(Variable = recode(Variable,
                           "Incidence_Lag1" = "I.1",
                           "Incidence_Lag2" = "I.2",
                           "Mobility_Lag1" = "M.1",
                           "Mobility_Lag2" = "M.2",
                           "Policy_Lag1" = "P.1",
                           "Policy_Lag2" = "P.2",
                           "Vaccination" = "Vacc"))
results_mobility_long <- processed_data_list[[2]]
results_mobility_long <- results_mobility_long %>%
  mutate(Variable = recode(Variable,
                           "Incidence_Lag1" = "I.1",
                           "Incidence_Lag2" = "I.2",
                           "Mobility_Lag1" = "M.1",
                           "Mobility_Lag2" = "M.2",
                           "Policy_Lag1" = "P.1",
                           "Policy_Lag2" = "P.2",
                           "Vaccination" = "Vacc"))
results_policy_long <- processed_data_list[[3]]
results_policy_long <- results_policy_long %>%
  mutate(Variable = recode(Variable,
                           "Incidence_Lag1" = "I.1",
                           "Incidence_Lag2" = "I.2",
                           "Mobility_Lag1" = "M.1",
                           "Mobility_Lag2" = "M.2",
                           "Policy_Lag1" = "P.1",
                           "Policy_Lag2" = "P.2",
                           "Vaccination" = "Vacc"))

plot_heatmap <- function(data, title, heatorder) {
  # 将 DIST 列转换为 factor，并明确指定 levels 顺序
  data$DIST <- factor(data$DIST, levels = rev(heatorder), ordered = TRUE)
  
  ggplot(data, aes(x = Variable, y = DIST, fill = Color)) +
    geom_tile(color = "black") +  # 添加黑色边框线
    scale_fill_identity() +  # 使用手动指定的颜色
    theme_minimal() +
    labs(title = title, x = "", y = "Districts") +
    theme(plot.background = element_rect(fill = "white", colour = NA),
          panel.background = element_rect(fill = "white", color = NA),
          text = element_text(size = 20, face = "bold"), 
          axis.title = element_text(size = 20, face = "bold"), # Axis titles
          plot.title = element_text(size = 20, face = "bold", hjust = 0.5),  # Title
          axis.text = element_text(size = 16, face = "bold"), # Axis text
          legend.title = element_text(size = 18, face = "bold"), # Legend title
          legend.text = element_text(size = 16, face = "bold"), # Legend text
          legend.box = "horizontal",
          axis.text.y = element_text(angle = 0),
          panel.grid = element_blank())
}

# 生成热图
incidence_heatmap <- plot_heatmap(results_incidence_long, "Incidence", heatorder)

mobility_heatmap <- plot_heatmap(results_mobility_long, "Mobility", heatorder)

policy_heatmap <- plot_heatmap(results_policy_long, "Policy", heatorder)


# 使用 patchwork 合并热图，并确保仅在第一个图中显示 y 轴
combined_heatmap <- (mobility_heatmap +                         
                       theme(axis.title.y = element_text(size = 20),  # 保留第一个图的y轴标题
                             axis.text.y = element_text(size = 12),   # 保留第一个图的y轴标签
                             axis.ticks.y = element_blank())) +      
  (incidence_heatmap +       
     theme(axis.title.y = element_blank(),          # 隐藏第二个图的y轴标题
           axis.text.y = element_blank(),           # 隐藏第二个图的y轴标签
           axis.ticks.y = element_blank())) +      
  (policy_heatmap +       
     theme(axis.title.y = element_blank(),          # 隐藏第三个图的y轴标题
           axis.text.y = element_blank(),           # 隐藏第三个图的y轴标签
           axis.ticks.y = element_blank())) +      
  plot_layout(ncol = 3, widths = c(1, 1, 1))
ggsave("../result/figure/combined_heatmap.png", combined_heatmap, dpi = 300, width = 16, height = 10)
```

```{r echo=FALSE}
# 初始化一个空的数据框来存储每个测试的p值结果
pvalue_results <- data.frame(District = character(),
                             Test = character(),
                             P_value = numeric(),
                             stringsAsFactors = FALSE)

# 滞后期数
lag <- 2
# 逐个地区进行Granger因果检验
for (district in dist_order) {
  
  # 选择发病率和流动性列
  incidence_col <- paste0(district, "_incidence")
  mobility_col <- paste0(district, "_mobility")
  
  # 转换为时间序列
  incidence_ts <- ts(merged_data[[incidence_col]], start = start_time, frequency = 52)
  mobility_ts <- ts(merged_data[[mobility_col]], start = start_time, frequency = 52)
  
  # 定义共享的政策和疫苗接种率时间序列
  policy_ts <- ts(merged_data$policy, start = start_time, frequency = 52)
  vacc_rate_ts <- ts(wholedata$vac_rate, start = start_time, frequency = 52)
  
  # 6个内生变量之间的Granger因果检验
  tests <- list(
    list("I → M", grangertest(mobility_ts ~ incidence_ts, order = lag)),
    list("M → I", grangertest(incidence_ts ~ mobility_ts, order = lag)),
    list("I → P", grangertest(policy_ts ~ incidence_ts, order = lag)),
    list("P → I", grangertest(incidence_ts ~ policy_ts, order = lag)),
    list("M → P", grangertest(policy_ts ~ mobility_ts, order = lag)),
    list("P → M", grangertest(mobility_ts ~ policy_ts, order = lag)),
    
    # 3个外生变量对内生变量的Granger因果检验
    list("V → I", grangertest(incidence_ts ~ vacc_rate_ts, order = lag)),
    list("V → M", grangertest(mobility_ts ~ vacc_rate_ts, order = lag)),
    list("V → P", grangertest(policy_ts ~ vacc_rate_ts, order = lag))
  )
  
  # 保存每个检验的p值
  for (test in tests) {
    test_name <- test[[1]]
    p_value <- test[[2]]$`Pr(>F)`[2]  # 提取p值
    pvalue_results <- rbind(pvalue_results, data.frame(District = district,
                                                       Test = test_name,
                                                       P_value = p_value))
  }
}
sum(pvalue_results$P_value < 0.1)
nrow(pvalue_results)
# 假设 pvalue_results 已经创建完成
# 你要将 'District' 作为行，'Test' 作为列，并将 P_value 作为值填入。

# 使用 tidyr 包进行数据转换
library(tidyr)

# 将数据转换为宽格式：'District' 作为行，'Test' 作为列，P_value 作为值
pvalue_wide <- pvalue_results %>%
  pivot_wider(names_from = Test, values_from = P_value)

# 按照指定的 dist_order 排序
pvalue_wide <- pvalue_wide %>% 
  slice(match(dist_order, District))

#write_xlsx(pvalue_wide, "../result/granger test.xlsx")
```